<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa Eletr√¥nica - Sistema Completo com PIX Din√¢mico</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
       /* RESET E CONFIGURA√á√ïES GERAIS */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(165deg, #0b0e14 0%, #1a1e26 100%);
    min-height: 100vh;
    padding: 24px;
    color: #e2e8f0;
    display: flex;
    flex-direction: column;
    position: relative;
}

.container {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 1280px;
    margin: 0 auto;
    width: 100%;
    gap: 24px;
}

/* HEADER E CONFIGURA√á√ïES */
.header {
    text-align: center;
    padding: 28px;
    background: rgba(26, 32, 44, 0.8);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 24px;
    border: 1px solid rgba(66, 153, 225, 0.3);
    box-shadow: 0 12px 32px -8px rgba(0, 0, 0, 0.5);
    transition: all 0.3s ease;
}

.header:hover {
    border-color: rgba(66, 153, 225, 0.6);
    box-shadow: 0 16px 40px -8px rgba(49, 130, 206, 0.2);
}

.header h1 {
    color: #fff;
    font-size: 2.2em;
    font-weight: 700;
    letter-spacing: -0.5px;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #90cdf4, #4299e1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 30px rgba(66, 153, 225, 0.3);
}

.item-config {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin: 20px auto 0;
    max-width: 900px;
    width: 100%;
    justify-content: center;
}

.config-group {
    flex: 1;
    min-width: 280px;
    max-width: 400px;
}

.config-label {
    display: block;
    color: #a0aec0;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 0.85em;
    text-align: left;
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.item-name-input,
.draw-date-input,
input[type="text"],
input[type="number"],
select,
textarea {
    width: 100%;
    padding: 14px 18px;
    background: #1e1e2a;
    border: 1.5px solid #2d3748;
    border-radius: 16px;
    color: #fff;
    font-size: 0.95em;
    transition: all 0.2s ease;
    font-family: inherit;
}

input:focus,
select:focus,
textarea:focus {
    outline: none;
    border-color: #4299e1;
    background: #252a34;
    box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.15);
}

.item-name-input.editable,
.draw-date-input.editable,
.observations-input.editable {
    border-color: #4299e1;
    background: #1e1e2a;
}

/* BOT√ïES */
.logout-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 24px;
    background: rgba(229, 62, 62, 0.9);
    border: none;
    border-radius: 30px;
    color: #fff;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    transition: all 0.2s ease;
    z-index: 1000;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    letter-spacing: 0.5px;
}

.logout-btn:hover {
    background: #e53e3e;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(229, 62, 62, 0.4);
}

.btn {
    padding: 14px 24px;
    border: none;
    border-radius: 30px;
    font-size: 0.9em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: #fff;
    box-shadow: 0 4px 12px rgba(49, 130, 206, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(49, 130, 206, 0.5);
}

.btn-secondary {
    background: #2d3748;
    color: #fff;
}

.btn-secondary:hover {
    background: #3a4556;
    transform: translateY(-2px);
}

.btn-pix {
    background: linear-gradient(135deg, #38b2ac, #319795);
    color: #fff;
    box-shadow: 0 4px 12px rgba(56, 178, 172, 0.3);
}

.btn-pix:hover {
    background: linear-gradient(135deg, #4fd1c5, #38b2ac);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(56, 178, 172, 0.5);
}

/* ESTAT√çSTICAS */
.stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.stat-card {
    background: rgba(26, 32, 44, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    padding: 20px;
    border-radius: 20px;
    text-align: center;
    min-width: 100px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    flex: 1;
    max-width: 130px;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.stat-card.available {
    background: linear-gradient(145deg, #2d3748, #1a202c);
    border-left: 4px solid #718096;
}

.stat-card.selected {
    background: linear-gradient(145deg, #2c3a4e, #1e2a36);
    border-left: 4px solid #4299e1;
}

.stat-card.reserved {
    background: linear-gradient(145deg, #3a2c2c, #2a1e1e);
    border-left: 4px solid #fc8181;
}

.stat-card h3 {
    color: #fff;
    font-size: 2em;
    font-weight: 700;
    margin-bottom: 6px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.stat-card p {
    color: #cbd5e0;
    font-size: 0.8em;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* BOT√ïES DE CONTROLE */
.control-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin: 16px 0;
    flex-wrap: wrap;
}

.control-btn {
    padding: 14px 28px;
    background: rgba(45, 55, 72, 0.8);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 30px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.control-btn:hover {
    transform: translateY(-2px);
    background: #4a5568;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

.control-btn.pix-btn {
    background: linear-gradient(135deg, #38b2ac, #319795);
}

.control-btn.admin-btn {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
}

/* N√öMEROS DA RIFA - CORRIGIDO */
.numbers-grid {
    display: grid;
    grid-template-columns: repeat(17, 1fr);
    gap: 8px;
    max-width: 1000px;
    margin: 0 auto 16px;
    padding: 20px;
    background: rgba(26, 32, 44, 0.5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 24px;
    border: 1px solid rgba(66, 153, 225, 0.2);
}

.number-card {
    aspect-ratio: 1;
    background: #1e1e2a;
    border: 1.5px solid #2d3748;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: all 0.15s ease;
    position: relative;
    overflow: hidden;
    padding: 4px;
    min-height: 0;
    min-width: 0;
    width: 100%;
    height: 100%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.number-card:hover:not(.reserved):not(.selected) {
    transform: translateY(-2px);
    border-color: #4299e1;
    background: #2a2f3a;
    box-shadow: 0 8px 16px rgba(66, 153, 225, 0.2);
}

.number-card.selected {
    background: linear-gradient(145deg, #3182ce, #2c5282);
    border-color: #4299e1;
    box-shadow: 0 8px 20px rgba(49, 130, 206, 0.4);
}

.number-card.reserved {
    background: linear-gradient(145deg, #c53030, #9b2c2c);
    border-color: #fc8181;
    cursor: not-allowed;
    box-shadow: 0 4px 12px rgba(197, 48, 48, 0.3);
}

.number {
    font-size: 1.4em;
    font-weight: 700;
    color: #fff;
    text-align: center;
    line-height: 1;
    display: block;
    width: 100%;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.owner-name {
    font-size: 0.6em;
    color: #fff;
    text-align: center;
    padding: 2px 6px;
    font-weight: 700;
    letter-spacing: 0.5px;
    line-height: 1;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 12px;
    backdrop-filter: blur(4px);
    display: inline-block;
    max-width: 90%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 2px;
    flex-shrink: 0;
}

/* RESPONSIVIDADE CORRIGIDA */
@media (max-width: 1024px) {
    .numbers-grid {
        grid-template-columns: repeat(12, 1fr);
        gap: 6px;
    }
    
    .number {
        font-size: 1.2em;
    }
    
    .owner-name {
        font-size: 0.55em;
        padding: 2px 4px;
    }
}

@media (max-width: 768px) {
    .numbers-grid {
        grid-template-columns: repeat(8, 1fr) !important;
        gap: 5px;
        padding: 16px;
    }
    
    .number-card {
        padding: 3px;
    }
    
    .number {
        font-size: 1.1em;
    }
    
    .owner-name {
        font-size: 0.5em;
        padding: 2px 4px;
        max-width: 95%;
    }
}

@media (max-width: 480px) {
    .numbers-grid {
        grid-template-columns: repeat(6, 1fr) !important;
        gap: 4px;
        padding: 12px;
    }
    
    .number-card {
        padding: 2px;
    }
    
    .number {
        font-size: 1em;
    }
    
    .owner-name {
        font-size: 0.45em;
        padding: 2px 3px;
        border-radius: 8px;
        max-width: 98%;
    }
}

@media (max-width: 360px) {
    .numbers-grid {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 3px;
    }
    
    .number-card {
        padding: 2px;
    }
    
    .number {
        font-size: 0.9em;
    }
    
    .owner-name {
        font-size: 0.4em;
        padding: 1px 2px;
        max-width: 100%;
    }
}

/* SE√á√ÉO PIX */
.pix-section {
    max-width: 900px;
    margin: 24px auto;
    padding: 28px;
    background: rgba(26, 32, 44, 0.8);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 28px;
    border: 1px solid rgba(56, 178, 172, 0.3);
    box-shadow: 0 16px 32px -8px rgba(0, 0, 0, 0.5);
}

.pix-title {
    color: #fff;
    font-size: 1.6em;
    font-weight: 700;
    text-align: center;
    margin-bottom: 24px;
    background: linear-gradient(135deg, #4fd1c5, #38b2ac);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.pix-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 28px;
}

@media (min-width: 768px) {
    .pix-content {
        flex-direction: row;
        align-items: flex-start;
    }
}

.pix-image-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    min-height: 300px;
}

.qr-code-container {
    width: 250px;
    height: 250px;
    background: white;
    border-radius: 20px;
    border: 1px solid rgba(56, 178, 172, 0.3);
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.3);
    padding: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

#pixQRCode {
    max-width: 100%;
    max-height: 100%;
    border-radius: 12px;
}

.pix-info {
    flex: 2;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.pix-code-container {
    background: #1a1e26;
    border: 1px solid rgba(56, 178, 172, 0.3);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 12px;
}

.pix-code-label {
    color: #4fd1c5;
    font-size: 0.9em;
    margin-bottom: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.pix-code {
    background: #0f1117;
    padding: 16px;
    border-radius: 16px;
    font-family: 'SF Mono', 'Courier New', monospace;
    font-size: 0.85em;
    color: #e2e8f0;
    text-align: center;
    word-break: break-all;
    border: 1px solid #2d3748;
    margin-bottom: 12px;
    min-height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.5;
    white-space: pre-wrap;
    max-height: 160px;
    overflow-y: auto;
}

.copy-pix-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #38b2ac, #319795);
    border: none;
    border-radius: 30px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.copy-pix-btn:hover {
    background: linear-gradient(135deg, #4fd1c5, #38b2ac);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(56, 178, 172, 0.4);
}

.copy-pix-btn.copied {
    background: linear-gradient(135deg, #4299e1, #3182ce);
}

.pix-instructions {
    background: #1a1e26;
    border: 1px solid rgba(237, 137, 54, 0.3);
    border-radius: 20px;
    padding: 20px;
    margin-top: 12px;
}

.pix-instructions h4 {
    color: #ed8936;
    margin-bottom: 12px;
    font-size: 1.1em;
    font-weight: 600;
}

.pix-instructions ol {
    padding-left: 24px;
    margin-bottom: 12px;
}

.pix-instructions li {
    margin-bottom: 8px;
    color: #cbd5e0;
    line-height: 1.5;
}

.pix-instructions .warning {
    color: #ed8936;
    font-weight: 600;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #2d3748;
    font-size: 0.9em;
}

/* CONFIGURA√á√ÉO PIX */
.pix-config-section {
    max-width: 600px;
    margin: 24px auto;
    padding: 28px;
    background: rgba(26, 32, 44, 0.9);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 28px;
    border: 1px solid rgba(66, 153, 225, 0.3);
    box-shadow: 0 16px 32px -8px rgba(0, 0, 0, 0.5);
    display: none;
}

.pix-config-title {
    color: #fff;
    font-size: 1.5em;
    font-weight: 700;
    text-align: center;
    margin-bottom: 24px;
    background: linear-gradient(135deg, #90cdf4, #4299e1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* LISTA DE COMPRADORES */
.buyers-section {
    max-width: 900px;
    margin: 0 auto 24px;
    padding: 0;
}

.buyers-container {
    background: rgba(26, 32, 44, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 24px;
    border: 1px solid rgba(237, 137, 54, 0.2);
    padding: 24px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
}

.buyers-title {
    color: #fff;
    font-size: 1.5em;
    font-weight: 700;
    text-align: center;
    margin-bottom: 20px;
    background: linear-gradient(135deg, #fbd38d, #ed8936);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.buyers-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
}

.buyer-card {
    background: #1e1e2a;
    border: 1px solid #2d3748;
    border-radius: 18px;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}

.buyer-card:hover {
    border-color: #ed8936;
    transform: translateX(4px);
    background: #252a34;
    box-shadow: 0 6px 16px rgba(237, 137, 54, 0.15);
}

.buyer-info {
    flex: 1;
}

.buyer-name {
    color: #fff;
    font-weight: 600;
    font-size: 1em;
    margin-bottom: 4px;
}

.buyer-numbers {
    color: #a0aec0;
    font-size: 0.8em;
}

.buyer-count {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: #fff;
    padding: 8px 14px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9em;
    min-width: 40px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(237, 137, 54, 0.3);
}

.empty-buyers,
.admin-empty {
    text-align: center;
    color: #718096;
    padding: 40px 20px;
    font-size: 1em;
}

.empty-buyers-icon,
.admin-empty-icon {
    font-size: 3em;
    margin-bottom: 12px;
    opacity: 0.5;
}

/* PAINEL ADMINISTRATIVO */
.admin-section {
    max-width: 900px;
    margin: 0 auto 24px;
    padding: 0;
    display: none;
}

.admin-container {
    background: rgba(26, 32, 44, 0.8);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: 24px;
    border: 1px solid rgba(245, 101, 101, 0.3);
    padding: 24px;
    box-shadow: 0 16px 32px -8px rgba(245, 101, 101, 0.2);
}

.admin-title {
    color: #fff;
    font-size: 1.5em;
    font-weight: 700;
    text-align: center;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #fc8181, #f56565);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.admin-subtitle {
    color: #a0aec0;
    text-align: center;
    margin-bottom: 20px;
    font-size: 0.85em;
}

.admin-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
}

.admin-buyer-card {
    background: #1e1e2a;
    border: 1px solid #2d3748;
    border-radius: 18px;
    padding: 18px;
    transition: all 0.2s ease;
}

.admin-buyer-card:hover {
    border-color: #f56565;
    background: #252a34;
    box-shadow: 0 6px 16px rgba(245, 101, 101, 0.15);
}

.admin-buyer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.admin-buyer-name {
    color: #fff;
    font-weight: 600;
    font-size: 1em;
}

.admin-buyer-count {
    background: linear-gradient(135deg, #f56565, #e53e3e);
    color: #fff;
    padding: 5px 12px;
    border-radius: 16px;
    font-weight: 700;
    font-size: 0.8em;
    box-shadow: 0 4px 10px rgba(229, 62, 62, 0.3);
}

.admin-numbers-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 14px;
}

.admin-number-badge {
    background: #1a1e26;
    border: 1.5px solid #ed8936;
    color: #ed8936;
    padding: 6px 12px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.8em;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.admin-number-badge:hover {
    background: #f56565;
    border-color: #f56565;
    color: #fff;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
}

.admin-actions {
    display: flex;
    gap: 10px;
}

.btn-admin-delete {
    flex: 1;
    padding: 10px;
    background: linear-gradient(135deg, #e53e3e, #c53030);
    border: none;
    border-radius: 12px;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    font-size: 0.75em;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
}

.btn-admin-delete:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(229, 62, 62, 0.5);
}

/* RODAP√â */
.footer {
    margin-top: auto;
    padding: 28px;
    background: rgba(26, 32, 44, 0.7);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    margin-top: 32px;
    box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.2);
}

.footer-content {
    max-width: 900px;
    margin: 0 auto;
}

.observations-container {
    margin-bottom: 20px;
}

.observations-label {
    display: block;
    color: #a0aec0;
    margin-bottom: 10px;
    font-weight: 600;
    font-size: 0.85em;
    letter-spacing: 0.5px;
}

.observations-input {
    min-height: 90px;
    resize: vertical;
    font-family: inherit;
    border-radius: 16px;
}

.footer-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #2d3748;
    color: #a0aec0;
    font-size: 0.85em;
}

.footer-info div {
    text-align: center;
    flex: 1;
}

.footer-info .center {
    font-weight: 600;
    color: #ed8936;
}

/* MODAIS */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.25s ease;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: #1e1e2a;
    padding: 32px;
    border-radius: 28px;
    border: 1px solid rgba(237, 137, 54, 0.3);
    max-width: 500px;
    width: 90%;
    box-shadow: 0 24px 48px -12px rgba(0, 0, 0, 0.8);
    animation: slideUp 0.3s ease;
    max-height: 90vh;
    overflow-y: auto;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-content h2 {
    color: #fff;
    margin-bottom: 20px;
    text-align: center;
    font-size: 1.6em;
    font-weight: 700;
    background: linear-gradient(135deg, #fbd38d, #ed8936);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.selected-numbers {
    background: #1a1e26;
    padding: 16px;
    border-radius: 16px;
    margin-bottom: 20px;
    text-align: center;
    max-height: 120px;
    overflow-y: auto;
}


.selected-numbers span {
    display: inline-block;
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: #fff;
    padding: 8px 16px;
    margin: 4px;
    border-radius: 30px;
    font-weight: 700;
    font-size: 1em;
    box-shadow: 0 4px 10px rgba(237, 137, 54, 0.3);
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    color: #a0aec0;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 0.85em;
    letter-spacing: 0.5px;
}

.modal-buttons {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

/* NOTIFICA√á√ÉO */
.notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: #fff;
    padding: 16px 32px;
    border-radius: 30px;
    box-shadow: 0 12px 28px -8px rgba(49, 130, 206, 0.5);
    display: none;
    z-index: 2000;
    animation: slideDown 0.3s ease;
    font-weight: 600;
    letter-spacing: 0.5px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(8px);
}

@keyframes slideDown {
    from {
        transform: translate(-50%, -80px);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

.notification.active {
    display: block;
}

/* CONFIRM MODAL */
.confirm-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.confirm-modal.active {
    display: flex;
}

.confirm-modal-content {
    background: #1e1e2a;
    padding: 32px;
    border-radius: 28px;
    border: 1px solid rgba(245, 101, 101, 0.3);
    max-width: 400px;
    width: 90%;
    box-shadow: 0 24px 48px -12px rgba(229, 62, 62, 0.3);
    text-align: center;
}

.confirm-modal-title {
    color: #fff;
    font-size: 1.4em;
    margin-bottom: 16px;
    font-weight: 700;
    background: linear-gradient(135deg, #fc8181, #f56565);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.confirm-modal-text {
    color: #cbd5e0;
    margin-bottom: 24px;
    line-height: 1.6;
    font-size: 0.95em;
}

.confirm-modal-buttons {
    display: flex;
    gap: 12px;
}

/* FOTO CONTAINER */
.foto-container {
    text-align: center;
    margin: 20px 0;
}

.foto-container img {
    width: 100%;
    max-width: 380px;
    height: auto;
    border-radius: 24px;
    border: 2px solid rgba(66, 153, 225, 0.3);
    box-shadow: 0 16px 32px -8px rgba(0, 0, 0, 0.5);
    transition: all 0.3s ease;
}

.foto-container img:hover {
    transform: scale(1.02);
    border-color: rgba(66, 153, 225, 0.8);
    box-shadow: 0 24px 48px -8px rgba(49, 130, 206, 0.3);
}

/* RESPONSIVIDADE */
@media (max-width: 1024px) {
    .numbers-grid {
        grid-template-columns: repeat(12, 1fr);
        gap: 6px;
        max-width: 900px;
    }
    
    .header h1 {
        font-size: 1.8em;
    }
}

@media (max-width: 768px) {
    body {
        padding: 16px;
    }
    
    .header {
        padding: 20px;
    }
    
    .header h1 {
        font-size: 1.5em;
    }

    .numbers-grid {
        grid-template-columns: repeat(8, 1fr) !important;
        gap: 5px;
        padding: 16px;
    }
    
    .number-card {
        min-height: 48px;
        min-width: 48px;
    }
    
    .number {
        font-size: 1.2em;
    }

    .stat-card {
        padding: 16px;
        min-width: 80px;
    }

    .stat-card h3 {
        font-size: 1.6em;
    }

    .buyers-list,
    .admin-list {
        grid-template-columns: 1fr;
    }

    .item-config {
        flex-direction: column;
        align-items: center;
    }

    .config-group {
        width: 100%;
        max-width: 100%;
    }

    .control-buttons {
        flex-direction: column;
        align-items: center;
    }

    .control-btn {
        width: 100%;
        max-width: 320px;
        justify-content: center;
    }

    .footer-info {
        flex-direction: column;
        gap: 12px;
        text-align: center;
    }

    .footer-info div {
        margin-bottom: 6px;
    }

    #pixQRCode,
    .qr-code-container {
        width: 200px;
        height: 200px;
    }
    
    .pix-section {
        padding: 20px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 12px;
    }

    .header {
        padding: 16px;
    }
    
    .header h1 {
        font-size: 1.3em;
    }

    .stats {
        gap: 12px;
    }

    .stat-card {
        padding: 12px;
        min-width: 70px;
    }

    .stat-card h3 {
        font-size: 1.4em;
    }

    .stat-card p {
        font-size: 0.7em;
    }

    .numbers-grid {
        grid-template-columns: repeat(6, 1fr) !important;
        gap: 4px;
        padding: 12px;
    }
    
    .number-card {
        min-height: 44px;
        min-width: 44px;
    }
    
    .number {
        font-size: 1em;
    }
    
    .owner-name {
        font-size: 0.6em;
        padding: 2px 4px;
    }

    .observations-input {
        min-height: 70px;
    }
    
    .modal-content {
        padding: 24px;
    }
}

@media (max-width: 360px) {
    .numbers-grid {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 3px;
    }
    
    .number-card {
        min-height: 40px;
        min-width: 40px;
    }
    
    .control-btn {
        padding: 12px 20px;
        font-size: 0.8em;
    }
}

/* SCROLLBAR PERSONALIZADA */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: #1a1e26;
}

::-webkit-scrollbar-thumb {
    background: #4a5568;
    border-radius: 20px;
}

::-webkit-scrollbar-thumb:hover {
    background: #718096;
}

/* ANIMA√á√ïES ADICIONAIS */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.pulse {
    animation: pulse 2s infinite;
}

/* GLASSMORPHISM EFFECT */
.glass {
    background: rgba(26, 32, 44, 0.6);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

/* TIPOGRAFIA */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');


/* CONTAINER PULSANTE PARA JO√ÉO MARIANO DA SILVA */
@keyframes pulseBlueContainer {
    0% {
        background: rgba(66, 153, 225, 0.1);
        box-shadow: 0 0 15px rgba(66, 153, 225, 0.3), 0 4px 15px rgba(0, 0, 0, 0.2);
        border-color: rgba(66, 153, 225, 0.4);
        transform: scale(1);
    }
    50% {
        background: rgba(66, 153, 225, 0.25);
        box-shadow: 0 0 30px #4299e1, 0 0 45px #3182ce, 0 4px 25px rgba(0, 0, 0, 0.3);
        border-color: #4299e1;
        transform: scale(1.02);
    }
    100% {
        background: rgba(66, 153, 225, 0.1);
        box-shadow: 0 0 15px rgba(66, 153, 225, 0.3), 0 4px 15px rgba(0, 0, 0, 0.2);
        border-color: rgba(66, 153, 225, 0.4);
        transform: scale(1);
    }
}

.nome-pulsante-container {
    animation: pulseBlueContainer 2s ease-in-out infinite;
    padding: 20px 30px;
    margin: 20px auto 15px;
    border-radius: 60px;
    border: 2px solid rgba(66, 153, 225, 0.4);
    display: inline-block;
    width: fit-content;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    background: rgba(26, 32, 44, 0.6);
    max-width: 90%;
}

.nome-pulsante-container h1 {
    animation: none !important;
    margin: 0 !important;
    padding: 0 !important;
    font-size: 1.1em;
    font-weight: 600;
    letter-spacing: 1px;
    color: #90cdf4;
    text-shadow: 0 0 10px #4299e1, 0 0 20px #3182ce;
    background: none;
    -webkit-text-fill-color: initial;
    background-clip: initial;
    border: none;
    box-shadow: none;
}

/* Responsividade */
@media (max-width: 768px) {
    .nome-pulsante-container {
        padding: 15px 25px;
    }
    .nome-pulsante-container h1 {
        font-size: 1.8em;
    }
}

@media (max-width: 480px) {
    .nome-pulsante-container {
        padding: 12px 20px;
    }
    .nome-pulsante-container h1 {
        font-size: 1.5em;
    }
}

@media (max-width: 360px) {
    .nome-pulsante-container {
        padding: 10px 18px;
    }
    .nome-pulsante-container h1 {
        font-size: 1.3em;
    }
}


.texto {    
    padding: 20px 30px;
    margin: 20px auto 15px;
    
    display: inline-block;
    width: fit-content;
   
    max-width: 90%;
}



    </style>	
	
</head>
<body>
    <div class="container">
        <button class="logout-btn" onclick="logout()">Sair</button>

        <div class="notification" id="notification"></div>

        <div class="header">
            <h1>üéüÔ∏è A√á√ÉO ENTRE AMIGOS</h1>
			 <h1>Jo√£o Mariano da Silva</h1>
           <div class="foto-container">
  <img src="https://joao16mariano.github.io/sorteio/img/foto.png?v=1"
       alt="Foto">
</div>

<div class="item-config">
		<div class="config-group">
                    <label class="config-label">Nome do objeto da rifa:</label>
                    <input type="text" 
                           class="item-name-input" 
                           id="itemName" 
                           placeholder="Digite o nome do objeto da rifa..." 
                           maxlength="100">
                </div>
                <div class="config-group">
                    <label class="config-label">Final do 1.o Pr√™mio da Federal do dia:</label>
                    <input type="text" 
                           class="draw-date-input" 
                           id="drawDate" 
                           placeholder="DD/MM/AAAA" 
                           maxlength="10">
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card available">
                <h3 id="availableCount">100</h3>
                <p>Dispon√≠veis</p>
            </div>
            <div class="stat-card selected">
                <h3 id="selectedCount">0</h3>
                <p>Selecionados</p>
            </div>
            <div class="stat-card reserved">
                <h3 id="reservedCount">0</h3>
                <p>Reservados</p>
            </div>
        </div>

        <!-- BOT√ïES DE CONTROLE -->
        <div class="control-buttons">
            <button class="control-btn pix-btn" onclick="openPixConfig()">
                ‚öôÔ∏è Configurar PIX
            </button>
            <button class="control-btn" onclick="openReservationModal()">
                üìã Ver N√∫meros Selecionados
            </button>
            <button class="control-btn admin-btn" onclick="toggleAdminSection()">
                üîí Painel Admin
            </button>
            <button class="control-btn pix-btn" onclick="generatePixForSelectedNumbers()">
                üí∞ Gerar PIX Agora
            </button>
        </div>

        <!-- SE√á√ÉO CONFIGURA√á√ÉO PIX -->
        <div class="pix-config-section" id="pixConfigSection">
            <h2 class="pix-config-title">‚öôÔ∏è Configura√ß√£o do PIX Din√¢mico</h2>
            
            <div class="form-group">
                <label for="pixKey">Chave PIX:</label>
                <input type="text" 
                       id="pixKey" 
                       placeholder="Digite sua chave PIX (CPF, telefone, email ou chave aleat√≥ria)"
                       maxlength="100">
            </div>
            
            <div class="form-group">
                <label for="merchantName">Nome do Recebedor:</label>
                <input type="text" 
                       id="merchantName" 
                       placeholder="Nome que aparecer√° no pagamento"
                       maxlength="25">
            </div>
            
            <div class="form-group">
                <label for="merchantCity">Cidade do Recebedor:</label>
                <input type="text" 
                       id="merchantCity" 
                       placeholder="Cidade"
                       maxlength="15">
            </div>
            
            <div class="form-group">
                <label for="pricePerNumber">Valor por N√∫mero (R$):</label>
                <input type="number" 
                       id="pricePerNumber" 
                       placeholder="10.00"
                       step="0.01"
                       min="1"
                       value="10.00">
            </div>
            
            <div class="form-group">
                <label for="pixKeyType">Tipo de Chave PIX:</label>
                <select id="pixKeyType">
                    <option value="cpf">CPF</option>
                    <option value="cnpj">CNPJ</option>
                    <option value="phone">Telefone</option>
                    <option value="email">E-mail</option>
                    <option value="random">Chave Aleat√≥ria</option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="testPixCode()">
                    üîç Testar PIX
                </button>
                <button class="btn btn-primary" onclick="savePixConfig()">
                    üíæ Salvar Configura√ß√£o
                </button>
            </div>
            
            <!-- Preview do c√≥digo PIX gerado -->
            <div class="pix-code-container" style="margin-top: 20px; display: none;" id="pixPreview">
                <div class="pix-code-label">Pr√©-visualiza√ß√£o do C√≥digo PIX:</div>
                <div class="pix-code" id="generatedPixCode">...</div>
                <button class="copy-pix-btn" onclick="copyGeneratedPix()">
                    üìã Copiar C√≥digo PIX
                </button>
            </div>
        </div>

        <!-- PAINEL ADMINISTRATIVO -->
        <div class="admin-section" id="adminSection">
            <div class="admin-container">
                <h2 class="admin-title">üîí Painel do Administrador</h2>
                <p class="admin-subtitle">Clique em um n√∫mero para cancel√°-lo individualmente ou use o bot√£o para cancelar todos os n√∫meros de um comprador</p>
                <div class="admin-list" id="adminList">
                    <div class="admin-empty">
                        <div class="admin-empty-icon">üé´</div>
                        <p>Nenhuma reserva para gerenciar</p>
                    </div>
                </div>
            </div>
        </div>

<div class="nome-pulsante-container">
    <h1>Seleciona o n√∫mero e clic no bot√£o: Ver N√∫meros Selecionados</h1>
</div>



        <!-- CARTELA DE N√öMEROS -->
        <div class="numbers-grid" id="numbersGrid"></div>

        <!-- SE√á√ÉO PIX DIN√ÇMICO -->
        <div class="pix-section">
            <h2 class="pix-title">üí∞ Pagamento via PIX</h2>
            
            <div class="pix-content">
                <div class="pix-image-container">
                    <div class="qr-code-container">
                        <canvas id="pixQRCode"></canvas>
                    </div>
                    <p style="color: #aaa; font-size: 0.8em; text-align: center;">
                        Escaneie o QR Code com seu app banc√°rio
                    </p>
                    <div style="color: #ff8c00; font-weight: bold; margin-top: 10px; text-align: center;">
                        Valor Total: R$ <span id="totalAmount">0.00</span>
                    </div>
                </div>
                
                <div class="pix-info">
                    <div class="pix-code-container">
                        <div class="pix-code-label">C√≥digo PIX Copia e Cola:</div>
                        <div class="pix-code" id="pixCode">
                            Selecione os n√∫meros da rifa e clique em "Gerar PIX"
                        </div>
                        <button class="copy-pix-btn" id="copyPixBtn" onclick="copyPixCode()">
                            üìã Copiar C√≥digo PIX
                        </button>
                    </div>
                    
                    <div class="pix-instructions">
                        <h4>üìù Instru√ß√µes para pagamento:</h4>
                        <ol>
                            <li>Selecione os n√∫meros desejados na cartela acima</li>
                            <li>Clique em "Gerar PIX Agora" ou "Confirmar Reserva"</li>
                            <li>Copie o c√≥digo PIX acima ou escaneie o QR Code</li>
                            <li>Realize o pagamento no seu aplicativo banc√°rio</li>
                            <li>Envie o comprovante para o WhatsApp informado</li>
                        </ol>
                        <div class="warning">
                            ‚ö†Ô∏è Sua reserva ser√° confirmada apenas ap√≥s o envio do comprovante!
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LISTA DE COMPRADORES -->
        <div class="buyers-section">
            <div class="buyers-container">
                <h2 class="buyers-title">üë• Compradores</h2>
                <div class="buyers-list" id="buyersList">
                    <div class="empty-buyers">
                        <div class="empty-buyers-icon">üé´</div>
                        <p>Nenhum n√∫mero reservado ainda</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- RODAP√â -->
        <div class="footer">
            <div class="footer-content">
                <div class="observations-container">
                    <label class="observations-label">Observa√ß√µes:</label>
                    <textarea class="observations-input" 
                              id="observations" 
                              placeholder="Digite observa√ß√µes importantes sobre a rifa (regras, informa√ß√µes de contato, etc.)..."
                              maxlength="500"></textarea>
                </div>
                <div class="footer-info">
                    <div class="left">Sistema de Rifa Eletr√¥nica</div>
                    <div class="center">üéØ Boa sorte a todos! üéØ</div>
                    <div class="right">Total: 100 n√∫meros</div>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMA√á√ÉO DE RESERVA -->
        <div class="modal" id="confirmModal">
            <div class="modal-content">
                <h2>üìã Confirmar Reserva</h2>
                <div class="selected-numbers" id="selectedNumbersDisplay"></div>
                
                <div class="form-group">
                    <label for="userName">Seu Nome Completo:</label>
                    <input type="text" id="userName" placeholder="Digite seu nome completo" required>
                </div>
                
                <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="color: #00cc88; font-weight: bold; margin-bottom: 5px;">
                        Valor Total: R$ <span id="modalTotalAmount">0.00</span>
                    </div>
                    <div style="color: #aaa; font-size: 0.9em;">
                        N√∫meros selecionados: <span id="modalNumbersCount">0</span>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closeModal()">
                        Cancelar
                    </button>
                    <button class="btn btn-pix" onclick="generatePixFromModal()">
                        üí∞ Gerar PIX
                    </button>
                    <button class="btn btn-primary" onclick="confirmReservation()">
                        Confirmar Reserva
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIGURA√á√ÉO PIX -->
        <div class="modal" id="pixConfigModal">
            <div class="modal-content">
                <h2>‚öôÔ∏è Configura√ß√£o do PIX</h2>
                
                <div class="form-group">
                    <label for="modalPixKey">Chave PIX:</label>
                    <input type="text" 
                           id="modalPixKey" 
                           placeholder="Digite sua chave PIX"
                           maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="modalMerchantName">Nome do Recebedor:</label>
                    <input type="text" 
                           id="modalMerchantName" 
                           placeholder="Seu nome ou nome da loja"
                           maxlength="25">
                </div>
                
                <div class="form-group">
                    <label for="modalMerchantCity">Cidade:</label>
                    <input type="text" 
                           id="modalMerchantCity" 
                           placeholder="Sua cidade"
                           maxlength="15">
                </div>
                
                <div class="form-group">
                    <label for="modalPricePerNumber">Valor por N√∫mero (R$):</label>
                    <input type="number" 
                           id="modalPricePerNumber" 
                           placeholder="10.00"
                           step="0.01"
                           min="1"
                           value="10.00">
                </div>
                
                <div class="form-group">
                    <label for="modalPixKeyType">Tipo de Chave:</label>
                    <select id="modalPixKeyType">
                        <option value="cpf">CPF</option>
                        <option value="cnpj">CNPJ</option>
                        <option value="phone">Telefone</option>
                        <option value="email">E-mail</option>
                        <option value="random">Chave Aleat√≥ria</option>
                    </select>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="closePixConfigModal()">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="savePixConfigFromModal()">
                        üíæ Salvar
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMA√á√ÉO DE CANCELAMENTO -->
        <div class="confirm-modal" id="confirmCancelModal">
            <div class="confirm-modal-content">
                <h2 class="confirm-modal-title">‚ö†Ô∏è Confirmar Cancelamento</h2>
                <div class="confirm-modal-text" id="confirmCancelText"></div>
                <div class="confirm-modal-buttons">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()">N√£o, manter</button>
                    <button class="btn btn-primary" style="background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);" onclick="executeCancel()">Sim, cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, onValue, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC3Klr3vaXQmpvA0r5f4SGL3-8qqkvt5Z0",
            authDomain: "rifa-a3126.firebaseapp.com",
            databaseURL: "https://rifa-a3126-default-rtdb.firebaseio.com",
            projectId: "rifa-a3126",
            storageBucket: "rifa-a3126.firebasestorage.app",
            messagingSenderId: "777277903544",
            appId: "1:777277903544:web:34903dc33eae3ec98dda4d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Vari√°veis globais
        let selectedNumbers = new Set();
        let reservedNumbers = {};
        let currentUser = null;
        let isAdmin = false;
        let pixConfig = {
            pixKey: '',
            merchantName: 'RIFA ELETRONICA',
            merchantCity: 'SAO PAULO',
            pricePerNumber: 10.00,
            keyType: 'cpf'
        };
        let cancelAction = null;

        const ADMIN_EMAIL = 'mariano@gmail.com';

        // Inicializar sistema quando usu√°rio estiver autenticado
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                currentUser = user;
                isAdmin = user.email === ADMIN_EMAIL;

                if (isAdmin) {
                    document.getElementById('itemName').classList.add('editable');
                    document.getElementById('drawDate').classList.add('editable');
                    document.getElementById('observations').classList.add('editable');
                    document.getElementById('pixConfigSection').style.display = 'block';
                }

                initializeRaffle();
                setupEventListeners();
                loadPixConfig();
            }
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Configurar campos edit√°veis
            setupEditableField('itemName');
            setupEditableField('drawDate');
            setupEditableTextarea('observations');

            // Configurar m√°scara para data
            setupDateMask();

            // Carregar dados salvos
            loadSavedData();
            
            // Inicializar canvas do QR Code
            const canvas = document.getElementById('pixQRCode');
            canvas.width = 230;
            canvas.height = 230;
            drawInitialQRCode();
        }

        // Configurar campo de texto edit√°vel
        function setupEditableField(fieldId) {
            const field = document.getElementById(fieldId);

            field.addEventListener('focus', function() {
                if (!isAdmin) {
                    this.blur();
                }
            });

            field.addEventListener('blur', function() {
                if (isAdmin) {
                    saveFieldToFirebase(fieldId, this.value.trim());
                }
            });

            field.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && isAdmin) {
                    this.blur();
                    saveFieldToFirebase(fieldId, this.value.trim());
                }
            });
        }

        // Configurar textarea edit√°vel
        function setupEditableTextarea(fieldId) {
            const field = document.getElementById(fieldId);

            field.addEventListener('focus', function() {
                if (!isAdmin) {
                    this.blur();
                }
            });

            field.addEventListener('blur', function() {
                if (isAdmin) {
                    saveFieldToFirebase(fieldId, this.value.trim());
                }
            });
        }

        // Configurar m√°scara para data (DD/MM/AAAA)
        function setupDateMask() {
            const dateInput = document.getElementById('drawDate');

            dateInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');

                if (value.length > 2 && value.length <= 4) {
                    value = value.substring(0, 2) + '/' + value.substring(2);
                } else if (value.length > 4) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4) + '/' + value.substring(4, 8);
                }

                e.target.value = value;
            });

            dateInput.addEventListener('blur', function() {
                if (this.value && isAdmin) {
                    validateAndSaveDate(this);
                }
            });
        }

        // Validar e salvar data
        function validateAndSaveDate(dateInput) {
            const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;

            if (!dateRegex.test(dateInput.value)) {
                showNotification('Formato de data inv√°lido! Use DD/MM/AAAA');
                dateInput.focus();
                return;
            }

            const parts = dateInput.value.split('/');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);

            const date = new Date(year, month, day);

            if (date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) {
                showNotification('Data inv√°lida! Verifique o dia, m√™s e ano.');
                dateInput.focus();
                return;
            }

            saveFieldToFirebase('drawDate', dateInput.value.trim());
        }

        // Salvar campo no Firebase
        async function saveFieldToFirebase(fieldId, value) {
            try {
                const fieldRef = ref(database, `config/${fieldId}`);
                await set(fieldRef, value);
                showNotification(`‚úÖ ${getFieldLabel(fieldId)} atualizado com sucesso!`);
            } catch (error) {
                console.error(`Erro ao salvar ${fieldId}:`, error);
                showNotification(`‚ùå Erro ao salvar ${getFieldLabel(fieldId)}: ${error.message}`);
            }
        }

        // Obter label amig√°vel para o campo
        function getFieldLabel(fieldId) {
            const labels = {
                'itemName': 'Nome do item',
                'drawDate': 'Data do sorteio',
                'observations': 'Observa√ß√µes',
                'pixKey': 'Chave PIX'
            };
            return labels[fieldId] || fieldId;
        }

        // Carregar dados salvos do Firebase
        function loadSavedData() {
            const configRef = ref(database, 'config');
            onValue(configRef, (snapshot) => {
                const config = snapshot.val() || {};

                if (config.itemName) {
                    document.getElementById('itemName').value = config.itemName;
                }

                if (config.drawDate) {
                    document.getElementById('drawDate').value = config.drawDate;
                }

                if (config.observations) {
                    document.getElementById('observations').value = config.observations;
                }
            });
        }

        // Carregar configura√ß√£o do PIX
        function loadPixConfig() {
            const pixConfigRef = ref(database, 'config/pixConfig');
            onValue(pixConfigRef, (snapshot) => {
                const savedConfig = snapshot.val();
                if (savedConfig) {
                    pixConfig = {
                        pixKey: savedConfig.pixKey || '',
                        merchantName: savedConfig.merchantName || 'RIFA ELETRONICA',
                        merchantCity: savedConfig.merchantCity || 'SAO PAULO',
                        pricePerNumber: savedConfig.pricePerNumber || 10.00,
                        keyType: savedConfig.keyType || 'cpf'
                    };

                    if (document.getElementById('pixKey')) {
                        document.getElementById('pixKey').value = pixConfig.pixKey;
                        document.getElementById('merchantName').value = pixConfig.merchantName;
                        document.getElementById('merchantCity').value = pixConfig.merchantCity;
                        document.getElementById('pricePerNumber').value = pixConfig.pricePerNumber;
                        document.getElementById('pixKeyType').value = pixConfig.keyType;
                    }
                }
            });
        }

        // Logout
        window.logout = async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                showNotification('‚ùå Erro ao sair: ' + error.message);
            }
        };

        // Inicializar rifa
        function initializeRaffle() {
            createNumberCards();
            loadReservedNumbers();
        }

        // Criar cards de n√∫meros
        function createNumberCards() {
            const grid = document.getElementById('numbersGrid');
            grid.innerHTML = '';

            for (let i = 0; i < 100; i++) {
                const numberStr = String(i).padStart(2, '0');
                const card = document.createElement('div');
                card.className = 'number-card';
                card.dataset.number = numberStr;
                card.innerHTML = `<div class="number">${numberStr}</div>`;

                card.addEventListener('click', () => toggleNumber(numberStr));
                grid.appendChild(card);
            }
        }

        // Carregar n√∫meros reservados do Firebase
        function loadReservedNumbers() {
            const raffleRef = ref(database, 'raffle');
            onValue(raffleRef, (snapshot) => {
                reservedNumbers = snapshot.val() || {};
                updateNumberCards();
                updateStats();
                
                if (isAdmin) {
                    updateAdminPanel();
                }
            });
        }

        // Extrair iniciais do nome
        function getInitials(name) {
            if (!name || typeof name !== 'string') return '??';
            const words = name.trim().split(' ').filter(word => word.length > 0);
            if (words.length === 1) {
                return words[0].substring(0, 2).toUpperCase();
            }
            return (words[0][0] + words[words.length - 1][0]).toUpperCase();
        }

        // Atualizar cards de n√∫meros
        function updateNumberCards() {
            document.querySelectorAll('.number-card').forEach(card => {
                const number = card.dataset.number;
                let ownerNameElement = card.querySelector('.owner-name');

                if (reservedNumbers[number]) {
                    card.classList.add('reserved');
                    card.classList.remove('selected');

                    const initials = getInitials(reservedNumbers[number].name);

                    if (!ownerNameElement) {
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'owner-name';
                        nameDiv.textContent = initials;
                        card.appendChild(nameDiv);
                    } else {
                        ownerNameElement.textContent = initials;
                    }
                } else {
                    card.classList.remove('reserved');
                    if (ownerNameElement) {
                        ownerNameElement.remove();
                    }

                    if (selectedNumbers.has(number)) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                }
            });
        }

        // Alternar sele√ß√£o de n√∫mero
        function toggleNumber(number) {
            if (reservedNumbers[number]) {
                showNotification('Este n√∫mero j√° est√° reservado!');
                return;
            }

            if (selectedNumbers.has(number)) {
                selectedNumbers.delete(number);
            } else {
                selectedNumbers.add(number);
            }

            updateNumberCards();
            updateStats();
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const reserved = Object.keys(reservedNumbers).length;
            const selected = selectedNumbers.size;
            const available = 100 - reserved - selected;

            document.getElementById('availableCount').textContent = available;
            document.getElementById('reservedCount').textContent = reserved;
            document.getElementById('selectedCount').textContent = selected;

            updateBuyersList();
        }

        // Atualizar lista de compradores
        function updateBuyersList() {
            const buyersList = document.getElementById('buyersList');

            if (Object.keys(reservedNumbers).length === 0) {
                buyersList.innerHTML = `
                    <div class="empty-buyers">
                        <div class="empty-buyers-icon">üé´</div>
                        <p>Nenhum n√∫mero reservado ainda</p>
                    </div>
                `;
                return;
            }

            // Agrupar n√∫meros por comprador
            const buyersMap = {};
            Object.keys(reservedNumbers).forEach(number => {
                const buyer = reservedNumbers[number];
                const name = buyer.name;

                if (!buyersMap[name]) {
                    buyersMap[name] = {
                        name: name,
                        numbers: [],
                        timestamp: buyer.timestamp
                    };
                }
                buyersMap[name].numbers.push(number);
            });

            // Ordenar n√∫meros de cada comprador
            Object.values(buyersMap).forEach(buyer => {
                buyer.numbers.sort((a, b) => parseInt(a) - parseInt(b));
            });

            // Ordenar compradores por timestamp
            const sortedBuyers = Object.values(buyersMap).sort((a, b) => b.timestamp - a.timestamp);

            // Renderizar lista
            buyersList.innerHTML = sortedBuyers.map(buyer => {
                const numbersText = buyer.numbers.length <= 5 
                    ? buyer.numbers.join(', ')
                    : `${buyer.numbers.slice(0, 5).join(', ')} +${buyer.numbers.length - 5}`;

                return `
                    <div class="buyer-card">
                        <div class="buyer-info">
                            <div class="buyer-name">${buyer.name}</div>
                            <div class="buyer-numbers">N√∫meros: ${numbersText}</div>
                        </div>
                        <div class="buyer-count">${buyer.numbers.length}</div>
                    </div>
                `;
            }).join('');
        }

        // Abrir modal de reserva
        window.openReservationModal = function() {
            if (selectedNumbers.size === 0) {
                showNotification('Selecione primeiro os n√∫meros da rifa!');
                return;
            }

            const modal = document.getElementById('confirmModal');
            const display = document.getElementById('selectedNumbersDisplay');
            const modalNumbersCount = document.getElementById('modalNumbersCount');
            const modalTotalAmount = document.getElementById('modalTotalAmount');

            display.innerHTML = '';
            const numbersArray = Array.from(selectedNumbers).sort();
            numbersArray.forEach(num => {
                const span = document.createElement('span');
                span.textContent = num;
                display.appendChild(span);
            });

            const totalAmount = (selectedNumbers.size * pixConfig.pricePerNumber).toFixed(2);
            modalNumbersCount.textContent = selectedNumbers.size;
            modalTotalAmount.textContent = totalAmount;

            modal.classList.add('active');
        };

        // Fechar modal
        window.closeModal = function() {
            document.getElementById('confirmModal').classList.remove('active');
            document.getElementById('userName').value = '';
        };

        // CONFIRMAR RESERVA - CORRIGIDO
        window.confirmReservation = async function() {
            const userName = document.getElementById('userName').value.trim();

            if (!userName) {
                showNotification('Por favor, digite seu nome!');
                return;
            }

            // Verificar se h√° configura√ß√£o PIX
            if (!pixConfig.pixKey) {
                showNotification('Configure primeiro a chave PIX!');
                closeModal();
                openPixConfig();
                return;
            }

            try {
                const raffleRef = ref(database, 'raffle');
                const snapshot = await get(raffleRef);
                const currentReserved = snapshot.val() || {};

                let hasConflict = false;
                const conflictNumbers = [];

                selectedNumbers.forEach(num => {
                    if (currentReserved[num]) {
                        hasConflict = true;
                        conflictNumbers.push(num);
                    }
                });

                if (hasConflict) {
                    showNotification(`Ops! Os n√∫meros ${conflictNumbers.join(', ')} j√° foram reservados. Escolha outros.`);
                    conflictNumbers.forEach(num => selectedNumbers.delete(num));
                    updateNumberCards();
                    updateStats();

                    if (selectedNumbers.size === 0) {
                        closeModal();
                    } else {
                        openReservationModal();
                    }
                    return;
                }

                // 1. GERAR PIX PRIMEIRO (antes de salvar no Firebase)
                if (selectedNumbers.size > 0) {
                    await generatePixForSelectedNumbers();
                }

                // 2. SALVAR NO FIREBASE
                const savePromises = [];
                selectedNumbers.forEach(num => {
                    const numberRef = ref(database, `raffle/${num}`);
                    savePromises.push(
                        set(numberRef, {
                            name: userName,
                            timestamp: Date.now(),
                            userId: auth.currentUser.uid,
                            email: auth.currentUser.email
                        })
                    );
                });

                await Promise.all(savePromises);

                showNotification(`‚úÖ ${selectedNumbers.size} n√∫mero(s) reservado(s) com sucesso para ${userName}!`);
                
                // 3. LIMPAR AP√ìS TUDO ESTAR FEITO
                selectedNumbers.clear();
                closeModal();
                updateStats();

            } catch (error) {
                console.error('Erro ao reservar n√∫meros:', error);
                showNotification('‚ùå Erro ao reservar n√∫meros: ' + error.message);
            }
        };

        // Gerar PIX a partir do modal
        window.generatePixFromModal = function() {
            // Gerar PIX sem fechar o modal imediatamente
            generatePixForSelectedNumbers();
        };

        // FUN√á√ïES DO PIX DIN√ÇMICO

        // Formatador de chave PIX
        function formatPixKey(key, keyType) {
            let formattedKey = key.trim();
            
            switch(keyType) {
                case 'cpf':
                    formattedKey = formattedKey.replace(/\D/g, '');
                    if (formattedKey.length !== 11) {
                        throw new Error('CPF deve ter 11 d√≠gitos');
                    }
                    break;
                    
                case 'cnpj':
                    formattedKey = formattedKey.replace(/\D/g, '');
                    if (formattedKey.length !== 14) {
                        throw new Error('CNPJ deve ter 14 d√≠gitos');
                    }
                    break;
                    
                case 'phone':
                    formattedKey = formattedKey.replace(/\D/g, '');
                    if (formattedKey.length === 11) {
                        formattedKey = '55' + formattedKey;
                    } else if (formattedKey.length === 10) {
                        formattedKey = '55' + formattedKey;
                    } else {
                        throw new Error('Telefone deve ter 10 ou 11 d√≠gitos');
                    }
                    break;
                    
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(formattedKey)) {
                        throw new Error('Email inv√°lido');
                    }
                    formattedKey = formattedKey.toLowerCase();
                    break;
                    
                case 'random':
                    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    if (!uuidRegex.test(formattedKey)) {
                        throw new Error('Chave aleat√≥ria deve ser um UUID v√°lido');
                    }
                    break;
                    
                default:
                    throw new Error('Tipo de chave inv√°lido');
            }
            
            return formattedKey;
        }

        // Gerar c√≥digo PIX CORRETO
        function generatePixCode(pixKey, merchantName, merchantCity, amount, description = "") {
            try {
                if (!pixKey || pixKey.length < 5) {
                    throw new Error('Chave PIX inv√°lida');
                }
                
                // Converter amount para n√∫mero e fixar casas decimais
                const amountNum = parseFloat(amount);
                if (isNaN(amountNum) || amountNum <= 0) {
                    throw new Error('Valor inv√°lido');
                }
                
                const amountStr = amountNum.toFixed(2); // Converte para string com 2 casas decimais
                
                // Fun√ß√£o auxiliar para formatar campos
                function formatarCampo(id, valor) {
                    const valorStr = String(valor);
                    return id + String(valorStr.length).padStart(2, '0') + valorStr;
                }
                
                // Nome e cidade limitados e sem caracteres especiais
                const nome = (merchantName || '').substring(0, 25).replace(/[^\x20-\x7E]/g, '');
                const cidade = (merchantCity || '').substring(0, 15).replace(/[^\x20-\x7E]/g, '');
                
                if (!nome || !cidade) {
                    throw new Error('Nome ou cidade inv√°lidos');
                }
                
                // Construir payload PIX corretamente
                let payload = 
                    "000201" + // Payload Format Indicator
                    formatarCampo("26", // Merchant Account Information
                        formatarCampo("00", "BR.GOV.BCB.PIX") +
                        formatarCampo("01", pixKey)
                    ) +
                    "52040000" + // Merchant Category Code
                    "5303986" + // Transaction Currency (986 = BRL)
                    formatarCampo("54", amountStr) + // Transaction Amount
                    "5802BR" + // Country Code
                    formatarCampo("59", nome) + // Merchant Name
                    formatarCampo("60", cidade) + // Merchant City
                    formatarCampo("62", formatarCampo("05", "RIFA" + Date.now().toString().slice(-6))) + // TXID
                    "6304"; // CRC16 Field (sem o CRC ainda)
                
                // Calcular CRC16
                const crc = calculateCRC16(payload);
                payload += crc;
                
                console.log("PIX Code gerado:", payload.substring(0, 100) + "...");
                return payload;
                
            } catch (error) {
                console.error("Erro ao gerar PIX:", error);
                throw error;
            }
        }

        // Calcular CRC16
        function calculateCRC16(str) {
            let crc = 0xFFFF;
            for (let i = 0; i < str.length; i++) {
                crc ^= str.charCodeAt(i) << 8;
                for (let bit = 0; bit < 8; bit++) {
                    crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : crc << 1;
                }
                crc &= 0xFFFF;
            }
            return crc.toString(16).toUpperCase().padStart(4, '0');
        }

        // Gerar PIX para n√∫meros selecionados
        window.generatePixForSelectedNumbers = async function() {
            if (selectedNumbers.size === 0) {
                showNotification('Selecione primeiro os n√∫meros da rifa!');
                return;
            }
            
            if (!pixConfig.pixKey) {
                showNotification('Configure primeiro a chave PIX!');
                openPixConfig();
                return;
            }
            
            try {
                const formattedPixKey = formatPixKey(pixConfig.pixKey, pixConfig.keyType);
                const totalAmount = selectedNumbers.size * pixConfig.pricePerNumber;
                const numbersArray = Array.from(selectedNumbers).sort();
                const description = `RIFA-${numbersArray.length}-NUM-${numbersArray.join('-')}`;
                
                const pixCode = generatePixCode(
                    formattedPixKey,
                    pixConfig.merchantName,
                    pixConfig.merchantCity,
                    totalAmount,
                    description
                );
                
                if (!pixCode) {
                    throw new Error('Falha ao gerar c√≥digo PIX');
                }
                
                console.log("C√≥digo PIX gerado:", pixCode);
                
                document.getElementById('pixCode').textContent = pixCode;
                document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
                
                await generateQRCode(pixCode);
                
                showNotification(`üí∞ PIX gerado! Valor: R$ ${totalAmount.toFixed(2)}`);
                
                document.querySelector('.pix-section').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
            } catch (error) {
                console.error('Erro ao gerar PIX:', error);
                showNotification(`‚ùå Erro: ${error.message}`);
            }
        };

        // Gerar QR Code
        async function generateQRCode(pixCode) {
            return new Promise((resolve, reject) => {
                const canvas = document.getElementById('pixQRCode');
                const qrCodeContainer = document.querySelector('.qr-code-container');
                
                // Limpar canvas
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Definir tamanho do canvas
                canvas.width = 230;
                canvas.height = 230;
                
                // Configurar fundo branco
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                console.log("Gerando QR Code para:", pixCode.substring(0, 50) + "...");
                
                // Usar QRCode.toCanvas
                try {
                    QRCode.toCanvas(canvas, pixCode, {
                        width: 220,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        },
                        errorCorrectionLevel: 'M'
                    }, function(error) {
                        if (error) {
                            console.error('Erro ao gerar QR Code:', error);
                            // Fallback
                            drawManualQRCode(canvas, ctx, pixCode);
                            showNotification('‚ö†Ô∏è QR Code gerado com fallback');
                            resolve();
                        } else {
                            console.log('QR Code gerado com sucesso');
                            showNotification('‚úÖ QR Code gerado!');
                            resolve();
                        }
                    });
                } catch (error) {
                    console.error('Erro cr√≠tico ao gerar QR Code:', error);
                    // Fallback final
                    generateQRCodeWithAPI(pixCode, canvas);
                    resolve();
                }
            });
        }

        // Gerar QR Code com API externa (fallback)
        function generateQRCodeWithAPI(pixCode, canvas) {
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=230x230&data=${encodeURIComponent(pixCode)}&margin=10&format=png`;
            
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                console.log('QR Code gerado via API externa');
                showNotification('‚úÖ QR Code gerado via API!');
            };
            img.onerror = function() {
                console.error('Erro ao carregar QR Code da API');
                drawManualQRCode(canvas, canvas.getContext('2d'), pixCode);
                showNotification('‚ö†Ô∏è QR Code gerado com fallback manual');
            };
            img.src = qrCodeUrl;
        }

        // Desenhar QR Code manualmente (fallback simples)
        function drawManualQRCode(canvas, ctx, pixCode) {
            // Fundo branco
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Desenhar texto informativo
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('QR Code PIX', canvas.width/2, canvas.height/2 - 30);
            
            ctx.font = '12px Arial';
            ctx.fillText('Valor: R$ ' + document.getElementById('totalAmount').textContent, canvas.width/2, canvas.height/2 - 10);
            ctx.fillText('Use o c√≥digo abaixo', canvas.width/2, canvas.height/2 + 10);
            ctx.fillText('para pagar no app', canvas.width/2, canvas.height/2 + 30);
            
            // Desenhar borda
            ctx.strokeStyle = '#00cc88';
            ctx.lineWidth = 2;
            ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
        }

        // Desenhar QR Code inicial
        function drawInitialQRCode() {
            const canvas = document.getElementById('pixQRCode');
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#00cc88';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üí∞', canvas.width/2, canvas.height/2 - 10);
            
            ctx.fillStyle = '#666666';
            ctx.font = '12px Arial';
            ctx.fillText('Selecione n√∫meros', canvas.width/2, canvas.height/2 + 20);
            ctx.fillText('e clique em Gerar PIX', canvas.width/2, canvas.height/2 + 40);
        }

        // Copiar c√≥digo PIX
        window.copyPixCode = function() {
            const pixCode = document.getElementById('pixCode').textContent;
            
            if (!pixCode || pixCode.includes('Selecione')) {
                showNotification('Gere primeiro o c√≥digo PIX!');
                return;
            }
            
            navigator.clipboard.writeText(pixCode).then(() => {
                const copyBtn = document.getElementById('copyPixBtn');
                const originalText = copyBtn.innerHTML;
                
                copyBtn.innerHTML = '‚úÖ Copiado!';
                copyBtn.classList.add('copied');
                
                showNotification('‚úÖ C√≥digo PIX copiado!');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
                
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                showNotification('‚ùå Erro ao copiar. Tente manualmente.');
            });
        };

        // Mostrar/ocultar configura√ß√£o do PIX
        window.openPixConfig = function() {
            if (!isAdmin) {
                showNotification('Apenas administradores podem configurar o PIX.');
                return;
            }
            
            const modal = document.getElementById('pixConfigModal');
            
            document.getElementById('modalPixKey').value = pixConfig.pixKey;
            document.getElementById('modalMerchantName').value = pixConfig.merchantName;
            document.getElementById('modalMerchantCity').value = pixConfig.merchantCity;
            document.getElementById('modalPricePerNumber').value = pixConfig.pricePerNumber;
            document.getElementById('modalPixKeyType').value = pixConfig.keyType;
            
            modal.classList.add('active');
        };

        // Fechar modal de configura√ß√£o PIX
        window.closePixConfigModal = function() {
            document.getElementById('pixConfigModal').classList.remove('active');
        };

        // Salvar configura√ß√£o do PIX a partir do modal
        window.savePixConfigFromModal = async function() {
            try {
                const newConfig = {
                    pixKey: document.getElementById('modalPixKey').value.trim(),
                    merchantName: document.getElementById('modalMerchantName').value.trim(),
                    merchantCity: document.getElementById('modalMerchantCity').value.trim(),
                    pricePerNumber: parseFloat(document.getElementById('modalPricePerNumber').value) || 10.00,
                    keyType: document.getElementById('modalPixKeyType').value
                };
                
                if (!newConfig.pixKey) {
                    showNotification('Digite sua chave PIX!');
                    return;
                }
                
                if (!newConfig.merchantName) {
                    showNotification('Digite o nome do recebedor!');
                    return;
                }
                
                if (!newConfig.merchantCity) {
                    showNotification('Digite a cidade!');
                    return;
                }
                
                try {
                    formatPixKey(newConfig.pixKey, newConfig.keyType);
                } catch (error) {
                    showNotification(`Chave PIX inv√°lida: ${error.message}`);
                    return;
                }
                
                const configRef = ref(database, 'config/pixConfig');
                await set(configRef, newConfig);
                
                pixConfig = newConfig;
                closePixConfigModal();
                showNotification('‚úÖ Configura√ß√£o do PIX salva com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar configura√ß√£o:', error);
                showNotification('‚ùå Erro ao salvar: ' + error.message);
            }
        };

        // Testar c√≥digo PIX
        window.testPixCode = async function() {
            if (!pixConfig.pixKey) {
                showNotification('Configure primeiro a chave PIX!');
                return;
            }
            
            try {
                const formattedPixKey = formatPixKey(pixConfig.pixKey, pixConfig.keyType);
                
                const testPixCode = generatePixCode(
                    formattedPixKey,
                    pixConfig.merchantName,
                    pixConfig.merchantCity,
                    pixConfig.pricePerNumber,
                    "TESTE RIFA ELETRONICA"
                );
                
                if (testPixCode) {
                    document.getElementById('generatedPixCode').textContent = testPixCode;
                    document.getElementById('pixPreview').style.display = 'block';
                    
                    // Criar canvas para teste
                    const testCanvas = document.createElement('canvas');
                    testCanvas.width = 150;
                    testCanvas.height = 150;
                    
                    // Gerar QR Code para teste
                    QRCode.toCanvas(testCanvas, testPixCode, {
                        width: 150,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function(error) {
                        if (error) {
                            console.error('Erro ao gerar QR Code de teste:', error);
                            showNotification('‚ö†Ô∏è C√≥digo gerado, mas QR Code falhou');
                        } else {
                            const preview = document.getElementById('pixPreview');
                            testCanvas.style.margin = '10px auto';
                            testCanvas.style.display = 'block';
                            testCanvas.style.border = '1px solid #ddd';
                            testCanvas.style.borderRadius = '8px';
                            
                            // Limpar e adicionar o canvas
                            const existingCanvas = preview.querySelector('canvas');
                            if (existingCanvas) {
                                existingCanvas.remove();
                            }
                            preview.insertBefore(testCanvas, document.getElementById('generatedPixCode'));
                            
                            showNotification('‚úÖ C√≥digo de teste gerado! Verifique no seu banco.');
                        }
                    });
                }
                
            } catch (error) {
                showNotification(`‚ùå Erro no teste: ${error.message}`);
            }
        };

        // Salvar configura√ß√£o do PIX da se√ß√£o
        window.savePixConfig = async function() {
            const newConfig = {
                pixKey: document.getElementById('pixKey').value.trim(),
                merchantName: document.getElementById('merchantName').value.trim(),
                merchantCity: document.getElementById('merchantCity').value.trim(),
                pricePerNumber: parseFloat(document.getElementById('pricePerNumber').value) || 10.00,
                keyType: document.getElementById('pixKeyType').value
            };
            
            if (!newConfig.pixKey) {
                showNotification('Digite sua chave PIX!');
                return;
            }
            
            try {
                const configRef = ref(database, 'config/pixConfig');
                await set(configRef, newConfig);
                
                pixConfig = newConfig;
                showNotification('‚úÖ Configura√ß√£o do PIX salva com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar configura√ß√£o PIX:', error);
                showNotification('‚ùå Erro ao salvar configura√ß√£o: ' + error.message);
            }
        };

        // Copiar c√≥digo PIX gerado no teste
        window.copyGeneratedPix = function() {
            const pixCode = document.getElementById('generatedPixCode').textContent;
            navigator.clipboard.writeText(pixCode).then(() => {
                showNotification('‚úÖ C√≥digo PIX de teste copiado!');
            });
        };

        // Mostrar/ocultar painel administrativo
        window.toggleAdminSection = function() {
            if (!isAdmin) {
                showNotification('Apenas administradores podem acessar o painel administrativo.');
                return;
            }
            
            const adminSection = document.getElementById('adminSection');
            if (adminSection.style.display === 'none' || adminSection.style.display === '') {
                adminSection.style.display = 'block';
                updateAdminPanel();
            } else {
                adminSection.style.display = 'none';
            }
        };

        // Atualizar painel administrativo
        function updateAdminPanel() {
            if (!isAdmin) return;

            const adminList = document.getElementById('adminList');

            if (Object.keys(reservedNumbers).length === 0) {
                adminList.innerHTML = `
                    <div class="admin-empty">
                        <div class="admin-empty-icon">üé´</div>
                        <p>Nenhuma reserva para gerenciar</p>
                    </div>
                `;
                return;
            }

            // Agrupar n√∫meros por comprador
            const buyersMap = {};
            Object.keys(reservedNumbers).forEach(number => {
                const buyer = reservedNumbers[number];
                const name = buyer.name;

                if (!buyersMap[name]) {
                    buyersMap[name] = {
                        name: name,
                        numbers: [],
                        timestamp: buyer.timestamp
                    };
                }
                buyersMap[name].numbers.push(number);
            });

            // Ordenar n√∫meros de cada comprador
            Object.values(buyersMap).forEach(buyer => {
                buyer.numbers.sort((a, b) => parseInt(a) - parseInt(b));
            });

            // Ordenar compradores por timestamp
            const sortedBuyers = Object.values(buyersMap).sort((a, b) => a.timestamp - b.timestamp);

            // Renderizar lista administrativa
            adminList.innerHTML = sortedBuyers.map(buyer => {
                const numbersHtml = buyer.numbers.map(num => 
                    `<span class="admin-number-badge" onclick="cancelSingleNumber('${num}', '${buyer.name}')">${num}</span>`
                ).join('');

                return `
                    <div class="admin-buyer-card">
                        <div class="admin-buyer-header">
                            <div class="admin-buyer-name">${buyer.name}</div>
                            <div class="admin-buyer-count">${buyer.numbers.length} n√∫meros</div>
                        </div>
                        <div class="admin-numbers-grid">
                            ${numbersHtml}
                        </div>
                        <div class="admin-actions">
                            <button class="btn-admin-delete" onclick="cancelAllNumbersFromBuyer('${buyer.name}')">
                                üóëÔ∏è Cancelar Todos
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Cancelar um √∫nico n√∫mero
        window.cancelSingleNumber = function(number, buyerName) {
            if (!isAdmin) {
                showNotification('Acesso negado: apenas administradores podem cancelar n√∫meros.');
                return;
            }

            cancelAction = {
                type: 'single',
                number: number,
                buyerName: buyerName
            };

            document.getElementById('confirmCancelText').innerHTML = `
                Tem certeza que deseja cancelar o n√∫mero <strong>${number}</strong> de <strong>${buyerName}</strong>?
                <br><br>
                Esta a√ß√£o n√£o pode ser desfeita.
            `;

            document.getElementById('confirmCancelModal').classList.add('active');
        };

        // Cancelar todos os n√∫meros de um comprador
        window.cancelAllNumbersFromBuyer = function(buyerName) {
            if (!isAdmin) {
                showNotification('Acesso negado: apenas administradores podem cancelar n√∫meros.');
                return;
            }

            const numbers = Object.keys(reservedNumbers).filter(num => 
                reservedNumbers[num].name === buyerName
            );

            cancelAction = {
                type: 'all',
                buyerName: buyerName,
                numbers: numbers
            };

            document.getElementById('confirmCancelText').innerHTML = `
                Tem certeza que deseja cancelar <strong>TODOS os ${numbers.length} n√∫meros</strong> de <strong>${buyerName}</strong>?
                <br><br>
                N√∫meros: ${numbers.join(', ')}
                <br><br>
                Esta a√ß√£o n√£o pode ser desfeita.
            `;

            document.getElementById('confirmCancelModal').classList.add('active');
        };

        // Fechar modal de confirma√ß√£o
        window.closeConfirmModal = function() {
            document.getElementById('confirmCancelModal').classList.remove('active');
            cancelAction = null;
        };

        // Executar cancelamento
        window.executeCancel = async function() {
            if (!isAdmin) {
                closeConfirmModal();
                return;
            }

            if (!cancelAction) {
                closeConfirmModal();
                return;
            }

            try {
                if (cancelAction.type === 'single') {
                    const numberRef = ref(database, `raffle/${cancelAction.number}`);
                    await remove(numberRef);
                    showNotification(`‚úÖ N√∫mero ${cancelAction.number} cancelado com sucesso!`);

                } else if (cancelAction.type === 'all') {
                    const deletePromises = cancelAction.numbers.map(num => {
                        const numberRef = ref(database, `raffle/${num}`);
                        return remove(numberRef);
                    });

                    await Promise.all(deletePromises);
                    showNotification(`‚úÖ Todos os ${cancelAction.numbers.length} n√∫meros de ${cancelAction.buyerName} foram cancelados!`);
                }

                closeConfirmModal();

            } catch (error) {
                console.error('Erro ao cancelar:', error);
                showNotification('‚ùå Erro ao cancelar: ' + error.message);
                closeConfirmModal();
            }
        };

        // Mostrar notifica√ß√£o
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('active');

            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
numbers-grid
